/*
  Copyright (c) 2025 Webcrumbs, Inc.

  This project is licensed under the GNU Affero General Public License v3.0 (AGPL-3.0).
  You may copy, distribute, and modify this software under the terms of the AGPL-3.0 license.
  See https://www.gnu.org/licenses/agpl-3.0.html for full terms.
*/
(()=>{var m="[Webcrumbs]",w={log:"\u{1F535}",info:"\u{1F7E2}",warn:"\u{1F7E1}",error:"\u{1F534}",debug:"\u{1F7E3}",time:"\u23F1\uFE0F"},c={log:(t,e)=>d("log",t,e),info:(t,e)=>d("info",t,e),warn:(t,e)=>d("warn",t,e),error:(t,e)=>d("error",t,e),debug:(t,e)=>d("debug",t,e),time:t=>u("time",t),timeEnd:t=>u("timeEnd",t)};function d(t,e,o){let n=`${m} ${w[t]} ${e}`;o?console[t](n,o):console[t](n)}function u(t,e){let o=`${m} ${w.time} ${e}`;t==="time"?console.time(o):t==="timeEnd"&&console.timeEnd(o)}var l=class extends HTMLElement{static observedAttributes=["uri"];connectedCallback(){this.loaded={script:!1,style:!1,fonts:!1};let e=this.getAttribute("uri");if(e?.endsWith("/")&&(e=e.slice(0,-1)),!e||!/^https?:\/\//.test(e)){c.error('Invalid or missing "uri" attribute. Use the tag like:','<webcrumbs-plugin uri="https://plugins.webcrumbs.dev/your-plugin"></webcrumbs-plugin>');return}this.renderFrom(e)}async renderFrom(e){c.time(`Timing for ${e}`),window.webcrumbsRegistry||(window.webcrumbsRegistry={});let o=`${e}/style.css`,n=`${e}/bundle.js`;await Promise.all([this.loadStyle(o),this.loadScript(n),this.loadFonts(o)]);let{Component:r,React:s,ReactDOM:i}=window.webcrumbs??{};if(!r||!s||!i){c.error("Plugin failed to load. Please check that your plugin exports the component correctly.","Expected exports: { Component, React, ReactDOM }.");return}window.webcrumbsRegistry[e]={Component:r,React:s,ReactDOM:i},this.renderShadow(r,s,i),c.timeEnd(`Timing for ${e}`)}async loadFonts(e,o=500){try{let n=await fetch(e,{headers:{Range:`bytes=0-${o-1}`}});if(n.ok){let r=await n.text(),s=Array.from(r.matchAll(/@import\s+url\((.*?)\);/g)).map(i=>i[1].replace(/^['"]|['"]$/g,""));window.__webcrumbsFontRegistry||(window.__webcrumbsFontRegistry=new Set);for(let i of s)if(!window.__webcrumbsFontRegistry.has(i)){if([...document.styleSheets].some(b=>b.href===i))continue;let a=document.createElement("link");a.rel="stylesheet",a.href=i,document.head.appendChild(a),window.__webcrumbsFontRegistry.add(i)}document.fonts.ready.then(()=>{c.debug("Loaded fonts"),this.loaded.fonts=!0})}}catch(n){c.warn("Couldn't load styles",e,n)}}async loadStyle(e){return new Promise(o=>{let n=this.shadowRoot||this.attachShadow({mode:"open"}),r=document.createElement("link");r.rel="stylesheet",r.href=e,r.onload=()=>{c.debug("Loaded style"),this.loaded.style=!0,requestAnimationFrame(o)},n.appendChild(r)})}renderShadow(e,o,n){n.createRoot(this.shadowRoot).render(o.createElement(e)),c.debug("Rendered plugin")}loadScript(e){return window.__webcrumbsScriptCache||(window.__webcrumbsScriptCache={}),window.__webcrumbsScriptCache[e]||(window.__webcrumbsScriptCache[e]=new Promise((o,n)=>{let r=document.querySelector(`script[src="${e}"]`);if(r){r.addEventListener("load",o),r.addEventListener("error",n);return}let s=document.createElement("script");s.src=e,s.onload=()=>{c.debug("Loaded code"),this.loaded.script=!0,o()},s.onerror=n,document.head.appendChild(s)})),window.__webcrumbsScriptCache[e]}};customElements.define("webcrumbs-plugin",l);})();
